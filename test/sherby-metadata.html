<!doctype html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, minimum-scale=1, initial-scale=1, user-scalable=yes">

  <title>sherby-metadata test</title>

  <script src="../node_modules/@webcomponents/webcomponentsjs/webcomponents-loader.js"></script>
  <script src="../node_modules/wct-browser-legacy/browser.js"></script>

  <script type="module" src="../sherby-metadata.js"></script>
</head>

<body>
  <test-fixture id="basic">
    <template>
      <sherby-metadata></sherby-metadata>
    </template>
  </test-fixture>

  <script type="module">
    import { afterNextRender } from '@polymer/polymer/lib/utils/render-status.js';
    
    suite('sherby-metadata', () => {
      let meta;

      setup(() => {
        meta = fixture('basic');
      });

      test('sets meta tags when we set meta data', () => {
        meta.data = {
          'description': 'Description from data',
          'og:description': 'Description from data (OpenGraph)',
          'og:title': 'Title from data (OpenGraph)',
          'title': 'Title from data',
        };

        const d = document.querySelector('meta[name="description"]');
        const od = document.querySelector('meta[property="og:description"]');
        const ot = document.querySelector('meta[property="og:title"]');

        assert.equal(d.content, 'Description from data');
        assert.equal(document.title, 'Title from data');
        assert.equal(od.content, 'Description from data (OpenGraph)');
        assert.equal(ot.content, 'Title from data (OpenGraph)');
      });

      test('sets meta tags when there is a sherby-metadata event', (done) => {
        const event = new CustomEvent('sherby-metadata', {
          bubbles: true,
          detail: {
            'description': 'Description from event',
            'og:description': 'Description from event (OpenGraph)',
            'og:title': 'Title from event (OpenGraph)',
            'title': 'Title from event',
          },
        });

        sinon.spy(meta, '_dataChanged');

        afterNextRender(window, () => {
          window.dispatchEvent(event);

          expect(meta._dataChanged.callCount).to.be.equal(1);

          const d = document.querySelector('meta[name="description"]');
          const od = document.querySelector('meta[property="og:description"]');
          const ot = document.querySelector('meta[property="og:title"]');

          assert.equal(d.content, 'Description from event');
          assert.equal(document.title, 'Title from event');
          assert.equal(od.content, 'Description from event (OpenGraph)');
          assert.equal(ot.content, 'Title from event (OpenGraph)');

          done();
        });
      });
    });
  </script>
</body>

</html>
